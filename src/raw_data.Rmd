---
title: "Raw Data Table Creation"
author: "Kateryna Savchyn"
date: "2019-05-30"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_knit$set(echo = TRUE)
```

## Data Sources Description

### Arlington County Police Incident Log

Source: [Police Incident Log](http://bit.ly/21nPzoE)
Last Updated: 2019-06-06 00:01 EDT
Frequency: Daily
Time Coverage: 2015-01-01 - Present
Type: REST/JSON

### ABC Virginia Hearing and Appeals: Final Decisions

Source: [ABC Hearings and Appeals](https://www.abc.virginia.gov/enforcement/hearings-and-appeals/final-decisions/)
Last Updated: 2014-07 - 2018-06
Frequency: Annual
Type: Excel (XLS) One file per version

### ABC Virginia Licensee Data

Source: [ABC Licensees](https://www.abc.virginia.gov/licenses/licensee-search-staging)
Version 2010-04 - 2019-06
Type: Excel (XLSX)

### Arlington Restaurant Initiative Participants

Source: [Arlington Restaurant Initiative GIS Data](https://gisdata-arlgis.opendata.arcgis.com/datasets/arlington-restaurant-initiative)
Version: 2019-05-21

## Install Packages

```{r load packages, message=FALSE}
for (pkg in c("lubridate", "purrr", "maditr", "here", "httr", "RPostgreSQL",
              "readxl", "stringr", "sf")) {
  library(pkg, character.only = TRUE)
  }
```

## Environmental Variables Used

- `db_userid`
- `db_pwd`
- `arlington_api_key`

## Data Scraping

```{r police log}
crime_incidents <- function() {
  today_is <- today()
  path <- here("data", "acpd", "original", str_c("police-incidents-log_", today_is, ".tsv"))
  if (file.exists(path)) {
    message("Police Log data up to date.")
    }
  str_c("https://api.data.arlingtonva.us/api/v2/",
        "datastreams/POLIC-INCID-LOG-19589/data.csv/?auth_key=",
        Sys.getenv(x = "arlington_api_key")) %>%
    GET() %>%
    content(as = 'text', encoding = 'UTF-8') %>%
    fread() %>%
    fwrite(file = path, sep = "\t")
  list.files(path = here("data", "acpd", "original")) %>%
    str_subset(pattern = "police-incidents-log_\\d{4}-\\d{2}-\\d{2}.tsv") %>%
    subset(str_extract(string = ., pattern = "\\d{4}-\\d{2}-\\d{2}") != today_is) %>%
    file.remove()
  conn <- dbConnect(drv = PostgreSQL(),
                    dbname = "acpd",
                    host = "postgis_1",
                    port = 5432L,
                    user = Sys.getenv("db_userid"),
                    password = Sys.getenv("db_pwd"))
  fread(input = path) %>%
    dt_mutate(firstReportDtm = as_datetime(x = firstReportDtm, tz = "EST5EDT"),
              lastReportDtm = as_datetime(x = lastReportDtm, tz = "EST5EDT")) %>%
    setnames(old = 'reportNbr', new = 'id') %>%
    setnames(old = 'offenseDsc', new = 'description') %>%
    setnames(old = 'locationName', new = 'location') %>%
    setnames(old = 'latitudeCrd', new = 'latitude') %>%
    setnames(old = 'longitudeCrd', new = 'longitude') %>%
    setnames(old = 'firstReportDtm', new = 'start') %>%
    setnames(old = 'lastReportDtm', new = 'end') %>%
    dbWriteTable(con = conn,
                 name = 'police_log',
                 value = .,
                 row.names = FALSE,
                 overwrite = TRUE)
  on.exit(expr = dbDisconnect(conn = conn))
  }
crime_incidents()
```

```{r abc violations, message = FALSE}
abc_violations <- function() {
  path <- here("data", "acpd", "original", "abc_violations")
  if (!dir.exists(paths = path)) {
    dir.create(path = path)
    }
  urls <- str_c("https://www.abc.virginia.gov/library/enforcement/other-documents/",
                c("finalboardorders_july2017-june2018.xls",
                  "fy17-final-board-order-spreadsheet.xlsx",
                  "finalboardorders_july2015-june2016.xls",
                  "finalboardorders_july2014-june2015.xls"),
                "?la=en")
  periods <- c("2017-07-2018-06.xls",
               "2016-07-2017-06.xlsx",
               "2015-07-2016-06.xls",
               "2014-07-2015-06.xls")
  destfiles <- str_c(path, periods)
  for (idx in seq_along(along.with = destfiles)) {
    if (!file.exists(destfiles[idx])) {
      download.file(url = urls[idx], destfile = destfiles[idx])
      }
    }
  conn <- dbConnect(drv = PostgreSQL(),
                    dbname = "acpd",
                    host = "postgis_1",
                    port = 5432L,
                    user = Sys.getenv("db_userid"),
                    password = Sys.getenv("db_pwd"))
  if (!dbExistsTable(conn = conn, name = "abc_violations")) {
    list.files(path = "data/acpd/original/abc_violations",
               full.names = TRUE) %>%
      map_df(.f = function(path) {
        read_excel(path = path,
                   col_types = "text",
                   col_names = c("record_control_number", "name", "license", "address",
                                 "city", "state", "zip", "charges", "num_of_charges",
                                 "repeat_abc_offense", "region", "disposition_method",
                                 "date_violation", "continuance", "date_available_H_and_A",
                                 "date_heard", "date_decision", "date_disposition",
                                 "suspension_days", "civil_penalty",
                                 "mandatory_susp_w_civil_penalty", "probation_months",
                                 "revoked", "dismissed", "other"),
                   col_types = c("numeric", "text", "numeric", "text", "text", "text",
                                 "numeric", "text", "numeric", "text", "text", "text",
                                 "date", "text", "date", "date", "date", "date",
                                 "numeric", "numeric", "numeric", "text", "text", "text",
                                 "text", "skip", "skip", "skip", "skip", "skip", "skip",
                                 "skip"),
                   skip = 1L)
        }) %>%
      dt_filter(!is.na(x = license)) %>%
      dt_arrange(license) %>%
      dbWriteTable(con = conn,
                   name = 'abc_violations',
                   value = .,
                   row.names = FALSE)
    }
  on.exit(expr = dbDisconnect(conn = conn))
  }
abc_violations()
```

```{r pull and create license table}
abc_licensees <- function() {
  destfile <- here("data", "acpd", "original", "abc_licensees.xlsx")
  if (!file.exists(destfile)) {
    download.file(url = "https://www.abc.virginia.gov/library/licenses/other-documents/valicapril2019.xlsx?la=en",
                  destfile = destfile)
    }
  conn <- dbConnect(drv = PostgreSQL(),
                    host = "postgis_1",
                    port = 5432L,
                    dbname = "acpd",
                    user = Sys.getenv("db_userid"),
                    password = Sys.getenv("db_pwd"))
  if (!dbExistsTable(conn = conn, name = "abc_licensees")) {
    read_excel(path = destfile) %>%
      dbWriteTable(con = conn,
                   name = 'abc_licensees',
                   value = .,
                   row.names = FALSE)
    }
  on.exit(expr = dbDisconnect(conn = conn))
  }
abc_licensees()
```

```{r}
ari_restaurants_layer <- function() {
  conn <- dbConnect(drv = PostgreSQL(),
                    host = "postgis_1",
                    dbname = "acpd",
                    port = 5432L,
                    user = Sys.getenv("db_userid"),
                    password = Sys.getenv("db_pwd"))
  if (!dbExistsTable(conn = conn, name = "ari_restaurants")) {
    st_read(dsn = "https://opendata.arcgis.com/datasets/2dc91350ea6f4bffb65ece8730b7fcca_0.geojson") %>%
    st_write(dsn = conn, layer = "ari_restaurants")
    }
  on.exit(expr = dbDisconnect(conn = conn))
  }
ari_restaurants_layer()
```