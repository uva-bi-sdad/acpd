---
title: "Similarity_Indexing"
author: "Kateryna Savchyn"
date: "7/22/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Bring In Data + Clean

```{r packages, message=FALSE}
library(here)
library(readxl)
library(maditr)
library(tidyr)
library(stringr)
library(dplyr)
library(hutils)
library(philentropy)
library(cluster)
```

```{r sim data}
dat <- here::here('data', 'acpd', 'Similarity_Matrix', 'similaritymatrix_f.xlsx')
sim <- read_excel(dat) 
# break list of categories into multiple columns
sim$Category_ns <- ''
sim$Category_ns <- str_trim(sim$Category) 
# all unique categories, to check
# cats <- paste(sim$Category_ns, collapse=',' )
# uniq_cats <- unique(unlist(strsplit(cats, ","))) %>% str_trim()

sim_sep <- separate(sim, col = Category_ns,into = c('A','B', 'C'), sep = ',', remove = FALSE) %>% data.table()
sim_n <- drop_empty_cols(sim_sep)
# dcast the 3 cols 
sim1 <- dcast(sim_n, Restaurant + Address ~ A, function(x) 1, fill = 0)
names(sim1) <- str_trim(names(sim1))
sim2 <- dcast(sim_n, Restaurant + Address ~ B, function(x) 1, fill = 0)
#standardize duplicate names by adding the dupe counts together
names(sim2) <- str_trim(names(sim2))
names(sim2)[3] <- "Bars2"
names(sim2)[5] <- "Italian2"
names(sim2)[6] <- "Pizza2"
sim2$Bars_f <- sim2$Bars + sim2$Bars2
sim2$Italian_f <- sim2$Italian + sim2$Italian2
sim2$Pizza_f <- sim2$Pizza + sim2$Pizza2
sim2[ ,c('Pizza', 'Pizza2', 'Bars', 'Bars2', 'Italian', 'Italian2')] <- list(NULL)
sim3 <- dcast(sim_n, Restaurant + Address ~ C, function(x) 1, fill = 0)
names(sim3) <- str_trim(names(sim3))
names(sim3)[4] <- "Salad2"
sim3$Salad_f <- sim3$Salad + sim3$Salad2
sim3[ ,c('Salad', 'Salad2')] <- list(NULL)

# if sim1 and sim2 share columns, sum them
overlap = intersect(names(sim1[,3:length(names(sim1))]), names(sim2[,3:length(names(sim2))]))

sim2overlap <- sim2 %>% dt_select(overlap)
sim1overlap <- sim1 %>% dt_select(overlap)

sim_12 <- sim2overlap + sim1overlap
sim12_overlap <- cbind(Restaurant = sim1$Restaurant, Address = sim1$Address, sim_12)

sim2_non_overlap <- sim2 %>% dt_select(!names(sim2) %in% overlap)
# add in columns from sim2 which were not overlapping
sim12 <- merge(sim12_overlap, sim2_non_overlap, by = c('Restaurant', 'Address'))
# add in columns from sim1 which were not overlapping
sim1_non_overlap <- sim1 %>% dt_select(!names(sim1) %in% overlap)
sim12_final <- merge(sim12, sim1_non_overlap, by = c('Restaurant', 'Address'))

# create overlap between the joined 12 and 3 sets
overlap2 = intersect(names(sim12_final[,3:length(names(sim12_final))]), names(sim3[,3:length(names(sim3))])) 
sim123overlap <- sim12_final %>% dt_select(overlap2)
sim3overlap <- sim3 %>% dt_select(overlap2)
sim_123 <- sim123overlap + sim3overlap
sim123_overlap <- cbind(Restaurant = sim1$Restaurant, Address = sim1$Address, sim_123)
#add in non-overlapping cols from sim3
sim3_non_overlap <- sim3 %>% dt_select(!names(sim3) %in% overlap2)
sim123 <- merge(sim123_overlap, sim3_non_overlap, by = c('Restaurant', 'Address'))
# add in non-overlapping cols from sim12_final
sim12_f_non_overlapping <- sim12_final %>% dt_select(!names(sim12_final) %in% overlap2)
sim123_f <- merge(sim123, sim12_f_non_overlapping, by = c('Restaurant', 'Address'))
names(sim123_f)[12] <- 'drop'
sim123_f$drop <- NULL
#identify that these are the categories, not the attributes
names(sim123_f)[3:length(names(sim123_f))] <- gsub(' ', '', paste(names(sim123_f[,3:length(names(sim123_f))]), '_CAT'))

### Run through the names function to standardize the names
ari_names <- function(rest_name) {
  if (str_detect(string = rest_name,
                 pattern = "(?i)(Los Tios|Los Tios Grill)")) {
    "Los Tios"
  } else if (str_detect(string = rest_name,
                        pattern = "(?i)(ba ba|baba|baba bar|ba ba bar)")) {
    "BA BA"
  } else if (str_detect(string = rest_name,
                        pattern = "(?i)(buena|vida)")) {
    "Buena Vida"
  } else if (str_detect(string = rest_name,
                        pattern = "(?i)(liberty tavern)")) {
    "LT"
  } else if (str_detect(string = rest_name,
                        pattern = "(?i)(bracket|brakett|BR)")) {
    "BR"
  } else if (str_detect(string = rest_name,
                        pattern = "(?i)(don tito|DT)")) {
    "DT"
  } else if (str_detect(string = rest_name,
                        pattern = "(?i)(GOAT|G\\.O\\.A\\.T\\.|^GT$)")) {
    "GT"
  } else if (str_detect(string = rest_name,
                        pattern = "(?i)(freddie)")) {
    "Freddie's Beach Bar & Restaurant"
  } else if (str_detect(string = rest_name,
                        pattern = "(?i)(fredrico|federico)")) {
    "Federico Ristorante Italiano"
  } else if (str_detect(string = rest_name,
                        pattern = "(?i)(four courts)")) {
    "Ireland's Four Courts"
  } else if (str_detect(string = rest_name,
                        pattern = "(?i)(mexicali|^MB$)")) {
    "MB"
  } else if (str_detect(string = rest_name,
                        pattern = "(?i)(sullivan)")) {
    "O'Sullivan's Irish Pub"
  } else if (str_detect(string = rest_name,
                        pattern = "(?i)(punch bowl|PBS)")) {
    "PBS"
  } else if (str_detect(string = rest_name,
                        pattern = "(?i)(rhodeside)")) {
    "Rhodeside Grill"
  } else if (str_detect(string = rest_name,
                        pattern = "(?i)(samuel becket)")) {
    "Samuel Beckett's Irish Gastro Pub"
  } else if (str_detect(string = rest_name,
                        pattern = "(?i)(celtic)")) {
    "The Celtic House Irish Pub & Restaurant"
  } else if (str_detect(string = rest_name,
                        pattern = "(?i)(spirits of|spirit of|76)")) {
    "76"
  } else if (str_detect(string = rest_name,
                        pattern = "(?i)(ttt|mexican diner)")) {
    "TTT"
  } else if (str_detect(string = rest_name,
                        pattern = "(?i)(whitlow|WT)")) {
    "WT"
  } else if (str_detect(string = rest_name,
                        pattern = "(?i)(william jeffrey)")) {
    "William Jeffrey's Tavern"
  } else if (str_detect(string = rest_name,
                        pattern = "(?i)(wilson hardware|wh)")) {
    "WH"
  } else {
    rest_name
  }
}


```

```{r standardize names then filter}
#sim123_f$Restaurant_Standard  <- ari_names(sim123_f$Restaurant)

sim123_f <- sim123_f %>% dt_mutate(Restaurant_Standard = factor(map_chr(.x = Restaurant,
                                       .f = ari_names)))

d <- here::here('data', 'acpd',  'working', 'ari_restaurants.tsv') %>%
  fread()

## filter to only the restaurants we care about: 
sim123_f <- sim123_f[sim123_f$Restaurant_Standard %in% d$restaurant, ]

```



```{r data manipulation part 2}
#merge categories back with rest of data
sim_cat <- sim_n %>% dt_select(Restaurant, Address, Stars, Attributes, Yes_No, Total_Reviews, Friday_Closing_Time, Saturday_Closing_Time)
sim_cat_comp <- merge(sim_cat, sim123_f, by = c('Restaurant', 'Address'))

#filter to cast the yes/no attributes
yesno <- sim_cat_comp %>% dt_filter(Yes_No == 'Yes' | Yes_No == 'No')
#cast it
yesno_cast <- dcast(yesno, Restaurant + Address ~ Attributes + Yes_No, function(x) 1, fill = 0)

# just take the Yes columns
yes_cast <- yesno_cast %>% dt_select(grep("Yes", names(yesno_cast)))
yes_cast <- cbind(Restaurant = yesno_cast$Restaurant, Address = yesno_cast$Address, yes_cast)

#merge it back with other categories
yesno_full <- merge(distinct(sim_cat_comp %>% dt_select(-c(Attributes, Yes_No))), yes_cast, by = c('Restaurant', 'Address'))
yesno_full$Restaurant <- yesno_full$Restaurant_Standard
yesno_full$Restaurant_Standard <- NULL

```

The below creates a Jaccard dissimilarity matrix based on the binary feature-set, and treats each feature as of equal importance. Compare to more weight assigned to the Category (restaurant type) variables because they are of higher order classification. 


```{r similarity}
# compute euclidean similarity
binary <- yesno_full[,7:length(names(yesno_full))]
bin_m <- as.matrix(binary)


sim_jaccard <- distance(bin_m, method = "jaccard") # jaccard
sim_cos <- distance(bin_m, method = "cosine") # cosine
sim_gower <- distance(bin_m, method = "gower")# gower

sim_df_jaccard <- as.data.frame(sim_jaccard)
sim_df_cos <- as.data.frame(sim_cos)
sim_df_gower <- as.data.frame(sim_gower)

names(sim_df_jaccard) <- yesno_full$Restaurant
sim_df_jaccard$Restaurant <- yesno_full$Restaurant # the lower the score the MORE similar; 0 = identity
names(sim_df_cos) <- yesno_full$Restaurant
sim_df_cos$Restaurant <- yesno_full$Restaurant # the lower the score the MORE similar; 0 = identity
names(sim_df_gower) <- yesno_full$Restaurant
sim_df_gower$Restaurant <- yesno_full$Restaurant # the lower the score the MORE similar; 0 = identity

# which(sim_df_jaccard$`Afghan Kabob House` < .5)
which(sim_df_jaccard$`Courthaus Social` < .4)
# which(sim_df_cos$`Afghan Kabob House` < .000001)
# which(sim_df_gower$`Afghan Kabob House` < .09)
which(sim_df_gower$`Courthaus Social` < .08)

#write out jacc
put <- here::here('data', 'acpd', 'Similarity_Matrix', 'raw_similarity_scores_ari.csv')
write.csv(sim_df_jaccard, put)
```

Now try weighing the Category vars as more important because they are higher level tags compared to the attribure-level data. Use daisy from cluster package with gower and weights. No real changes were observed.

```{r weighted gower} 
sim_d <- daisy(bin_m, weights = c(rep.int(30,68), rep.int(1,38)))
sim_d_m <- as.matrix(sim_d)

sim_d_m_df <- as.data.frame(sim_d_m)
names(sim_d_m_df) <- yesno_full$Restaurant
sim_d_m_df$Restaurant <- yesno_full$Restaurant
which(sim_d_m_df$`Afghan Kabob House` < 3)
which(sim_d_m_df$`Courthaus Social` < 3)
```


```{r data for t-test}
# use Jaccard similarity; 
# replace identity matches with high number so we can pull the most similar match per restaurant'
j_noid <- replace.value(sim_df_jaccard, names(sim_df_jaccard), from=0, to=as.integer(10), verbose = FALSE)
ARI_list <- c('Baba','Bar Bao','Barley Mac',
'Bracket Room','Buena Vida Clarendon','Buena Vida Social Club',
"The Celtic House Irish Pub & Restaurant",'Courthaus Social','Crystal City Sports Pub',
'Don Tito','Federico Ristorante Italiano',
'Fiona’s Irish Pub',"Freddie’s Beach Bar & Restaurant",
"The G.O.A.T",'Ireland’s Four Courts','Lebanese Taverna',
"The Liberty Tavern","Los Tios Grill", "Lyon Hall", 'Medium Rare','Mexicali Blues',
'Nam Viet Restaurant',"O’Sullivan’s Irish Pub","Pamplona","Punch Bowl Social Arlington","Ragtime", "Rebellion On The Pike",
"Rhodeside Grill", "Samuel Beckett’s Irish Gastro Pub",
"Spirits of ‘76", "The Local Oyster", "TTT Mexican Diner", "Whitlow's On Wilson" , "William Jeffery’s Tavern",
"Wilson Hardware Kitchen & Bar" )

j_noid_ARI <- j_noid %>% dt_filter(Restaurant %in% ARI_list)
j_noid_notARI <- j_noid %>% dt_filter(!(Restaurant %in% ARI_list))

most_similar  <- character(length(j_noid_ARI$Restaurant))

for (i in 1:length(j_noid_ARI$Restaurant)){
  restaurant <- j_noid_ARI$Restaurant[i]
  min_not_ARI <- which.min(t(j_noid_notARI %>% dt_select(restaurant)))
  most_similar[i] <- names(j_noid_notARI)[min_not_ARI]
}

# get most similar that are not in the ARI program
ari_similarity <- data.frame(Restaurant = j_noid_ARI$Restaurant, Most_Similar = most_similar)

put <- here('data', 'acpd', 'Similarity_Matrix', 'ARI_sim_comparisons.csv')
write.csv(ari_similarity, put)

```



