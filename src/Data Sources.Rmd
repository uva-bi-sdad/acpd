---
title: 'ACPD: Data Sources'
output:
  html_document:
    code_folding: hide
    df_print: paged
    toc: yes
  html_notebook:
    code_folding: hide
    toc: yes
---

```{r setup}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
# setwd(dir = rprojroot::find_rstudio_root_file())
```

# Housekeeping
```{r}
pacman::p_load(sdalr, DBI, httr, jsonlite, readr, stringr, dplyr, data.table, dtplyr, purrr)
arlington_api_key = '140c712ce0aaf752160366975a7fa1cca8c81445'
google_api_key = 'AIzaSyAJwMuwL73uIxLhhhYoPkDymDFcQJVCtPA'
```

# Crime Incident Reports

- Source: [Police Incident Log](https://bit.ly/21nPzoE) "Arlington County Data API was used for this purpose, but it is not endorsed or certified by Arlington County."

- Temporal coverage: 2015-01-01 - Present (last updated 2018-06-14)

- Location: dbname = *jbsc* / name = *crime*

```{r}
# crime_incidence = function(arlington_api_key) {
#   output = str_c('https://api.data.arlingtonva.us/api/v2/',
#                         'datastreams/POLIC-INCID-LOG-19589/data.csv/?auth_key=',
#                         arlington_api_key) %>%
#     GET() %>%
#     content(as = 'text', encoding = 'UTF-8') %>%
#     read_csv() %>%
#     mutate(firstReportDtm = as.POSIXct(x = firstReportDtm, tz = 'EDT'),
#            lastReportDtm = as.POSIXct(x = lastReportDtm, tz = 'EDT')) %>%
#     data.table() %>%
#     setnames(old = 'reportNbr', new = 'id') %>%
#     setnames(old = 'offenseDsc', new = 'description') %>%
#     setnames(old = 'locationName', new = 'location') %>%
#     setnames(old = 'latitudeCrd', new = 'latitude') %>%
#     setnames(old = 'longitudeCrd', new = 'longitude') %>%
#     setnames(old = 'firstReportDtm', new = 'start') %>%
#     setnames(old = 'lastReportDtm', new = 'end')
#   conn = con_db(dbname = 'jbsc',
#                 pass = get_my_password())
#   dbWriteTable(con = conn,
#                name = 'crime',
#                value = output,
#                row.names = FALSE,
#                overwrite = TRUE)
#   on.exit(dbDisconnect(conn = conn))
#   }
# crime_incidence(arlington_api_key = arlington_api_key)
crime_incidence = function() {
  conn = con_db(dbname = 'jbsc',
                pass = get_my_password())
  output = dbReadTable(con = conn,
                       name = 'crime')
  on.exit(dbDisconnect(conn = conn))
  return(value = output)
}
crime_incidence = crime_incidence()
names(x = crime_incidence)
head(x = crime_incidence)
```

# ABC Violations

- Source: ABC Virginia [Hearing and Appeals: Final Decisions](https://www.abc.virginia.gov/enforcement/hearings-and-appeals/final-decisions/)

- [Glossary of Hearings and Appeals Terms](https://www.abc.virginia.gov/enforcement/hearings-and-appeals/key-terms/)

- Manually updated

- Temporal coverage (2014-07-01 - 2017-06-31)

- Location: dbname = *jbsc* / name = *abc*

```{r}
abc = function() {
  conn = con_db(dbname = 'jbsc',
                pass = get_my_password())
  output = dbReadTable(con = conn,
                       name = 'abc_violations_2014_07_2017_06') %>%
    data.table()
  on.exit(dbDisconnect(conn = conn))
  return(value = output)
}
abc = abc()
names(x = abc)
head(x = abc)
```

```{r geocoding}
geocode = function(address) {
  response = str_c('https://maps.googleapis.com/maps/api/geocode/json',
                    '?address=',
                   address,
                   '&key=',
                   google_api_key) %>%
    str_replace_all(pattern = '\\s',
                  replacement = '+') %>%
    GET()
  if (status_code(x = response) == 200L) {
    lon_lat = response %>%
      content(as = 'text',
              encoding = 'UTF-8') %>%
      fromJSON() %>%
      getElement(name = 'results') %>%
      getElement(name = 'geometry') %>%
      getElement(name = 'location')
    output = data.table(address = address,
                        longitude = lon_lat$lng,
                        latitude = lon_lat$lat)
  } else {
    output = data.table(address = address,
                        longitude = NA,
                        latitude = NA)
  }
  return(value = output)
}
arlington_address_geocoded = map_df(.x = abc %>%
                                      filter(city %in% 'ARLINGTON') %>%
                                      pull(address) %>%
                                      unique() %>%
                                      str_c(' Arlington, VA'),
                                    .f = geocode)
upload_geocoded = function() {
  conn = con_db(dbname = 'jbsc',
                pass = get_my_password())
  dbWriteTable(con = conn,
               name = 'geocoded',
               value = arlington_address_geocoded,
               row.names = FALSE,
               overwrite = TRUE)
  on.exit(dbDisconnect(conn = conn))
  }
upload_geocoded()
#   }
```

